<script>
    const usePaginatedTable = () => {
        const data = getTableData()
        let version = 0

        const columns = [
            { accessorKey: "id", header: "ID" },
            { accessorKey: "customerName", header: "Customer" },
            { accessorKey: "status", header: "Status" },
            { accessorKey: "amount", header: "Amount" },
            { accessorKey: "dateTime", header: "Order At" },
        ]

        const state = {
            columnPinning: { left: [], right: [] },
            pagination: {
                pageSize: 5,
                pageIndex: 0,
            },
        }

        const table = TableCore.createTable({
            state,
            data,
            columns,
            getCoreRowModel: TableCore.getCoreRowModel(),
            getPaginationRowModel: TableCore.getPaginationRowModel(),
            onStateChange: (updater) => {
                const newState = typeof updater === "function" ? updater(state) : updater
                Object.assign(state, newState)
            },
        })

        return {
            columns,
            flexRender,
            pageSizes: [5, 10, 20, 50],
            version,
            get table() {
                this.version
                return table
            },
            get visibleRows() {
                this.version
                return this.table.getRowModel().rows
            },
            get pageSize() {
                this.version
                return this.table.getState().pagination.pageSize
            },
            get pageIndex() {
                this.version
                return this.table.getState().pagination.pageIndex
            },
            get rowCount() {
                this.version
                return data.length
            },
            get start() {
                this.version
                return this.rowCount === 0 ? 0 : this.pageIndex * this.pageSize + 1
            },
            get end() {
                this.version
                return Math.min(this.start + this.pageSize - 1, this.rowCount)
            },

            setPageIndex(n) {
                this.table.setPageIndex(n)
                this.render()
            },

            nextPage() {
                this.version
                if (this.table.getCanNextPage()) {
                    this.table.setPageIndex(this.pageIndex + 1)
                    this.render()
                }
            },

            prevPage() {
                this.version
                if (this.table.getCanPreviousPage()) {
                    this.table.setPageIndex(this.pageIndex - 1)
                    this.render()
                }
            },

            changePageSize(newSize) {
                this.table.setPageSize(Number(newSize))
                this.render()
            },

            render() {
                this.version++
            },
        }
    }
</script>

<div x-data="usePaginatedTable()">
    <div class="overflow-x-auto">
        <table class="table">
            <thead>
                <template x-for="headerGroup in table.getHeaderGroups()" :key="headerGroup.id">
                    <tr>
                        <template x-for="header in headerGroup.headers" :key="header.id">
                            <th
                                x-show="!header.isPlaceholder"
                                x-text="flexRender(header.column.columnDef.header, header.getContext())"></th>
                        </template>
                    </tr>
                </template>
            </thead>
            <tbody>
                <template x-if="!visibleRows.length">
                    <tr>
                        <td :colspan="columns.length" class="h-24 text-center">No results.</td>
                    </tr>
                </template>
                <template x-if="visibleRows.length">
                    <template x-for="row in visibleRows" :key="row.id">
                        <tr>
                            <template x-for="cell in row.getVisibleCells()" :key="cell.id">
                                <td>
                                    <template x-if="cell.column.id === 'customerName'">
                                        <div class="flex items-center gap-2">
                                            <div class="avatar">
                                                <div
                                                    class="mask mask-squircle bg-base-200 h-9 w-9 px-0.5 pt-0.5">
                                                    <img
                                                        :src="cell.row.original.avatar"
                                                        alt="Avatar" />
                                                </div>
                                            </div>
                                            <div>
                                                <p
                                                    class="leading-none font-medium"
                                                    x-text="cell.row.original.customerName"></p>
                                                <p
                                                    class="text-base-content/70 mt-0.5 text-xs/none"
                                                    x-text="cell.row.original.email"></p>
                                            </div>
                                        </div>
                                    </template>

                                    <template x-if="cell.column.id === 'id'">
                                        <span
                                            class="text-base-content/70 font-mono text-xs uppercase"
                                            x-text="'#' + cell.row.original.id"></span>
                                    </template>

                                    <template x-if="cell.column.id === 'status'">
                                        <span
                                            :class="{
                  'badge badge-success badge-sm badge-soft': cell.row.original.status === 'success',
                  'badge badge-info badge-sm badge-soft': cell.row.original.status === 'processing',
                  'badge badge-error badge-sm badge-soft': cell.row.original.status === 'failed',
                  'badge badge-ghost badge-sm': ['pending', null, undefined].includes(cell.row.original.status)
                }"
                                            x-text="cell.row.original.status.charAt(0).toUpperCase() + cell.row.original.status.slice(1)"></span>
                                    </template>

                                    <template x-if="cell.column.id === 'dateTime'">
                                        <p class="space-x-1 whitespace-nowrap">
                                            <span
                                                x-text="new Date(cell.row.original.dateTime).toLocaleDateString('en-US', {
                      day: 'numeric', month: 'short', year: '2-digit'
                    })"></span>
                                            <span
                                                class="text-base-content/60 text-xs"
                                                x-text="new Date(cell.row.original.dateTime).toLocaleTimeString([], {
                        hour: '2-digit', minute: '2-digit'
                      })"></span>
                                        </p>
                                    </template>

                                    <template x-if="cell.column.id === 'amount'">
                                        <span
                                            class="text-base font-medium"
                                            x-text="'\$ '+cell.row.original.amount"></span>
                                    </template>

                                    <template
                                        x-if="!
              ['id', 'customerName', 'status', 'dateTime', 'amount'].includes(cell.column.id)">
                                        <span
                                            x-html="cell.column.columnDef.cell
                ? cell.column.columnDef.cell(cell.getContext())
                : cell.getValue()"></span>
                                    </template>
                                </td>
                            </template>
                        </tr>
                    </template>
                </template>
            </tbody>
        </table>
    </div>
    <div
        class="border-base-200 flex flex-wrap items-center justify-between gap-2 border-t border-dashed p-5">
        <div class="flex items-center gap-2">
            <p class="text-base-content/70 text-sm max-md:hidden">Items per page</p>
            <select
                aria-label="Items per page"
                class="select select-sm w-16"
                @change="changePageSize(Number($event.target.value))">
                <template x-for="size in pageSizes" :key="size">
                    <option :value="size" :selected="size === pageSize" x-text="size"></option>
                </template>
            </select>
        </div>

        <p class="text-base-content/70 text-sm max-md:hidden">
            Showing
            <span class="text-base-content font-medium" x-text="`${start}â€“${end}`"></span>
            out of
            <span class="text-base-content font-medium" x-text="rowCount"></span>
        </p>

        <div class="join">
            <button
                class="btn btn-square btn-sm btn-outline border-base-300 join-item"
                aria-label="Pagination controls"
                :disabled="!table.getCanPreviousPage()"
                @click="prevPage()">
                <span class="iconify lucide--arrow-left"></span>
            </button>

            <template x-for="i in table.getPageCount()" :key="i">
                <button
                    class="btn btn-square btn-sm btn-outline border-base-300 join-item"
                    @click="setPageIndex(i - 1)"
                    :class="{ 'btn-active': pageIndex === (i - 1) }"
                    x-text="i"></button>
            </template>

            <button
                class="btn btn-square btn-sm btn-outline border-base-300 join-item"
                aria-label="Pagination controls"
                :disabled="!table.getCanNextPage()"
                @click="nextPage()">
                <span class="iconify lucide--arrow-right"></span>
            </button>
        </div>
    </div>
</div>
