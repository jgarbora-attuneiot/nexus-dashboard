<script>
    const useRowSelectionTable = () => {
        const data = getTableData()
        let version = 0

        const columns = [
            { accessorKey: "id", header: "ID" },
            { accessorKey: "customerName", header: "Customer" },
            { accessorKey: "status", header: "Status" },
            { accessorKey: "amount", header: "Amount" },
            { accessorKey: "dateTime", header: "Order At" },
        ]

        const state = {
            columnPinning: { left: [], right: [] },
            pagination: {
                pageSize: 5,
                pageIndex: 0,
            },
            rowSelection: {},
        }

        const table = TableCore.createTable({
            state,
            data,
            columns,
            getCoreRowModel: TableCore.getCoreRowModel(),
            getPaginationRowModel: TableCore.getPaginationRowModel(),
            onStateChange: (updater) => {
                const newState = typeof updater === "function" ? updater(state) : updater
                Object.assign(state, newState)
            },
        })

        return {
            columns,
            flexRender,
            version,
            get table() {
                this.version
                return table
            },
            get visibleRows() {
                this.version
                return this.table.getRowModel().rows
            },
            get selectedCount() {
                return this.table.getSelectedRowModel().rows.length
            },
            get totalCount() {
                return this.table.getPaginationRowModel().rows.length
            },
            get isIndeterminateAllRowsSelected() {
                this.version
                return (
                    this.table.getIsSomePageRowsSelected() && !this.table.getIsAllPageRowsSelected()
                )
            },
            toggleSelectedRow(row) {
                row.toggleSelected()
                this.render()
            },
            isRowSelected(row) {
                this.version
                return row.getIsSelected()
            },
            toggleAllRowsSelected() {
                this.table.toggleAllPageRowsSelected()
                this.render()
            },
            render() {
                this.version++
            },
        }
    }
</script>

<div x-data="useRowSelectionTable()">
    <div class="border-base-200 border-b border-dashed p-5">
        <div class="text-base-content/70 text-center text-sm">
            <template x-if="selectedCount > 0">
                <p>
                    <span class="text-base-content font-medium" x-text="selectedCount"></span>
                    <span x-text="selectedCount === 1 ? ' row' : ' rows'"></span>
                    selected out of
                    <span class="text-base-content font-medium" x-text="totalCount"></span>
                </p>
            </template>

            <template x-if="selectedCount === 0">
                <span class="font-medium">Select a row</span>
            </template>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="table">
            <thead>
                <template x-for="headerGroup in table.getHeaderGroups()" :key="headerGroup.id">
                    <tr>
                        <th>
                            <input
                                aria-label="Select all rows"
                                type="checkbox"
                                class="checkbox checkbox-sm"
                                :checked="table.getIsAllPageRowsSelected()"
                                @change="toggleAllRowsSelected"
                                x-effect="$el.indeterminate = isIndeterminateAllRowsSelected" />
                        </th>
                        <template x-for="header in headerGroup.headers" :key="header.id">
                            <th
                                x-show="!header.isPlaceholder"
                                x-text="flexRender(header.column.columnDef.header, header.getContext())"></th>
                        </template>
                    </tr>
                </template>
            </thead>
            <tbody>
                <template x-if="!visibleRows.length">
                    <tr>
                        <td :colspan="columns.length" class="h-24 text-center">No results.</td>
                    </tr>
                </template>
                <template x-if="visibleRows.length">
                    <template x-for="row in visibleRows" :key="row.id">
                        <tr>
                            <td>
                                <input
                                    aria-label="Select row"
                                    type="checkbox"
                                    class="checkbox checkbox-sm"
                                    :checked="isRowSelected(row)"
                                    @change="toggleSelectedRow(row)" />
                            </td>
                            <template x-for="cell in row.getVisibleCells()" :key="cell.id">
                                <td>
                                    <template x-if="cell.column.id === 'customerName'">
                                        <div class="flex items-center gap-2">
                                            <div class="avatar">
                                                <div
                                                    class="mask mask-squircle bg-base-200 h-9 w-9 px-0.5 pt-0.5">
                                                    <img
                                                        :src="cell.row.original.avatar"
                                                        alt="Avatar" />
                                                </div>
                                            </div>
                                            <div>
                                                <p
                                                    class="leading-none font-medium"
                                                    x-text="cell.row.original.customerName"></p>
                                                <p
                                                    class="text-base-content/70 mt-0.5 text-xs/none"
                                                    x-text="cell.row.original.email"></p>
                                            </div>
                                        </div>
                                    </template>

                                    <template x-if="cell.column.id === 'id'">
                                        <span
                                            class="text-base-content/70 font-mono text-xs uppercase"
                                            x-text="'#' + cell.row.original.id"></span>
                                    </template>

                                    <template x-if="cell.column.id === 'status'">
                                        <span
                                            :class="{
                  'badge badge-success badge-sm badge-soft': cell.row.original.status === 'success',
                  'badge badge-info badge-sm badge-soft': cell.row.original.status === 'processing',
                  'badge badge-error badge-sm badge-soft': cell.row.original.status === 'failed',
                  'badge badge-ghost badge-sm': ['pending', null, undefined].includes(cell.row.original.status)
                }"
                                            x-text="cell.row.original.status.charAt(0).toUpperCase() + cell.row.original.status.slice(1)"></span>
                                    </template>

                                    <template x-if="cell.column.id === 'dateTime'">
                                        <p class="space-x-1 whitespace-nowrap">
                                            <span
                                                x-text="new Date(cell.row.original.dateTime).toLocaleDateString('en-US', {
                      day: 'numeric', month: 'short', year: '2-digit'
                    })"></span>
                                            <span
                                                class="text-base-content/60 text-xs"
                                                x-text="new Date(cell.row.original.dateTime).toLocaleTimeString([], {
                        hour: '2-digit', minute: '2-digit'
                      })"></span>
                                        </p>
                                    </template>

                                    <template x-if="cell.column.id === 'amount'">
                                        <span
                                            class="text-base font-medium"
                                            x-text="'\$ '+cell.row.original.amount"></span>
                                    </template>

                                    <template
                                        x-if="!
              ['id', 'customerName', 'status', 'dateTime', 'amount'].includes(cell.column.id)">
                                        <span
                                            x-html="cell.column.columnDef.cell
                ? cell.column.columnDef.cell(cell.getContext())
                : cell.getValue()"></span>
                                    </template>
                                </td>
                            </template>
                        </tr>
                    </template>
                </template>
            </tbody>
        </table>
    </div>
</div>
